<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æˆ‘ä»¬åœ¨ä¸€èµ·çš„æ—¶å…‰</title>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+SC:wght@500;700&family=Pacifico&display=swap" rel="stylesheet">
    <style>
        :root {
            --glass-bg: rgba(255, 255, 255, 0.25);
            --glass-border: rgba(255, 255, 255, 0.5);
            --text-color: #2c3e50;
            --light-text-color: #f8f8f8; /* é€‚åº”æ·±è‰²èƒŒæ™¯å›¾ */
            --heart-color: #ff6b6b;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        /* èƒŒæ™¯è½®æ’­å±‚ */
        .photo-carousel {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            z-index: 0;
            overflow: hidden;
        }

        .carousel-slide {
            position: absolute;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            opacity: 0;
            transition: opacity 3s ease-in-out;
            background-size: cover;
            background-position: center center;
            background-repeat: no-repeat;
        }

        .carousel-slide.active {
            opacity: 1;
        }

        .carousel-slide::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.2);
            z-index: 1;
        }

        body {
            height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            font-family: 'Noto Serif SC', serif;
            overflow: hidden;
            background-color: #f0f0f0; /* é»˜è®¤èƒŒæ™¯ï¼Œé˜²æ­¢å›¾ç‰‡åŠ è½½æ…¢ */
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
            transition: background-image 0.5s ease; /* å›¾ç‰‡åˆ‡æ¢åŠ¨ç”» */
        }

        /* é»˜è®¤æ¸å˜èƒŒæ™¯ï¼Œå¦‚æœæœªè®¾ç½®å›¾ç‰‡ */
        body.default-bg {
            background: linear-gradient(-45deg, #ee7752, #e73c7e, #23a6d5, #23d5ab);
            background-size: 400% 400%;
            animation: gradientBG 15s ease infinite;
        }

        @keyframes gradientBG {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        /* æ¼‚æµ®èƒŒæ™¯çˆ±å¿ƒ */
        .bg-heart {
            position: absolute;
            color: rgba(255, 255, 255, 0.3);
            animation: float 6s ease-in-out infinite;
            z-index: 0;
            user-select: none;
        }

        @keyframes float {
            0%, 100% { transform: translateY(0) rotate(0deg); }
            50% { transform: translateY(-20px) rotate(10deg); }
        }

        .container {
            position: relative;
            z-index: 10;
            background: var(--glass-bg);
            backdrop-filter: blur(16px);
            -webkit-backdrop-filter: blur(16px);
            border: 1px solid var(--glass-border);
            border-radius: 30px;
            padding: 4.5rem 3.5rem;
            text-align: center;
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.2);
            width: 90%;
            max-width: 900px;
            transition: transform 0.3s ease;
        }

        .container:hover { transform: translateY(-5px); }

        header h1 {
            font-family: 'Pacifico', cursive;
            font-size: 3.8rem;
            color: var(--light-text-color); /* é€‚åº”èƒŒæ™¯å›¾ï¼Œç™½è‰² */
            margin-bottom: 18px;
            text-shadow: 0 4px 10px rgba(0,0,0,0.3); /* æ›´å¼ºé˜´å½±çªå‡ºæ–‡å­— */
            letter-spacing: 2px;
        }

        header p {
            font-size: 1.3rem;
            color: var(--light-text-color); /* é€‚åº”èƒŒæ™¯å›¾ï¼Œç™½è‰² */
            opacity: 0.95;
            margin-bottom: 3rem;
            font-weight: 500;
            text-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }

        .heart-icon {
            color: var(--heart-color); /* çˆ±å¿ƒé¢œè‰²æ›´é†’ç›® */
            display: inline-block;
            animation: heartbeat 1.5s infinite;
        }

        @keyframes heartbeat {
            0%, 100% { transform: scale(1); }
            15% { transform: scale(1.3); }
            30% { transform: scale(1); }
            45% { transform: scale(1.15); }
        }

        /* å¹´æœˆæ—¥è®¡æ—¶å™¨æ ·å¼ */
        .year-month-day-timer {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
            margin-bottom: 2rem;
        }

        .year-month-day-box {
            background: rgba(255, 255, 255, 0.35);
            border-radius: 18px;
            padding: 18px 12px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            box-shadow: 0 6px 18px rgba(0, 0, 0, 0.15);
            transition: all 0.3s;
            backdrop-filter: blur(5px);
        }

        .year-month-day-box:hover {
            transform: scale(1.05);
            background: rgba(255, 255, 255, 0.45);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.25);
        }

        .year-month-day-value {
            font-size: 3rem;
            line-height: 1;
            font-weight: 800;
            color: #fff;
            margin-bottom: 8px;
            font-variant-numeric: tabular-nums;
            text-shadow: 0 3px 10px rgba(0, 0, 0, 0.4);
        }

        .year-month-day-label {
            font-size: 0.9rem;
            color: rgba(255, 255, 255, 0.9);
            font-weight: bold;
            letter-spacing: 1px;
            text-transform: uppercase;
        }

        .timer-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 20px;
            margin-bottom: 3rem;
        }

        .time-box {
            background: rgba(255, 255, 255, 0.45);
            border-radius: 20px;
            padding: 20px 10px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            box-shadow: 0 8px 20px rgba(0,0,0,0.05);
            transition: transform 0.3s;
        }
        
        .time-box:hover { transform: scale(1.05); }

        .time-value {
            font-size: 3.8rem;
            line-height: 1;
            font-weight: 700;
            color: var(--text-color);
            margin-bottom: 5px;
            font-variant-numeric: tabular-nums;
        }

        .time-label {
            font-size: 1.1rem;
            color: #4a4a4a;
            font-weight: bold;
        }

        .footer-quote {
            font-size: 1.2rem;
            color: var(--light-text-color); /* é€‚åº”èƒŒæ™¯å›¾ï¼Œç™½è‰² */
            border-top: 1px solid rgba(255,255,255,0.4);
            padding-top: 2rem;
            line-height: 1.8;
            text-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }

        /* è½®æ’­çŠ¶æ€æç¤º */
        .carousel-indicator {
            position: fixed;
            top: 20px;
            right: 20px;
            background: rgba(255, 255, 255, 0.3);
            backdrop-filter: blur(8px);
            -webkit-backdrop-filter: blur(8px);
            border: 1px solid rgba(255, 255, 255, 0.5);
            border-radius: 25px;
            padding: 8px 15px;
            color: white;
            font-size: 0.9rem;
            z-index: 15;
            font-weight: 500;
            text-shadow: 0 1px 3px rgba(0,0,0,0.3);
        }

        /* === ä¸Šä¼ æ§åˆ¶æŒ‰é’®ç»„ === */
        .upload-controls {
            position: absolute;
            bottom: 20px;
            left: 20px;
            display: flex;
            gap: 10px;
            z-index: 10;
            flex-direction: column;
            align-items: flex-start;
        }



        /* ä¸Šä¼ æŒ‰é’®æ ·å¼ */
        .upload-btn {
            background-color: rgba(255, 255, 255, 0.3);
            color: white;
            padding: 10px 15px;
            border-radius: 50px;
            font-size: 0.9rem;
            cursor: pointer;
            border: 1px solid rgba(255, 255, 255, 0.5);
            backdrop-filter: blur(8px);
            -webkit-backdrop-filter: blur(8px);
            transition: background-color 0.3s, transform 0.3s;
        }

        .toggle-btn {
            background-color: rgba(255, 255, 255, 0.3);
            color: white;
            padding: 10px 15px;
            border-radius: 50px;
            font-size: 0.9rem;
            cursor: pointer;
            border: 1px solid rgba(255, 255, 255, 0.5);
            backdrop-filter: blur(8px);
            -webkit-backdrop-filter: blur(8px);
            transition: background-color 0.3s, transform 0.3s;
            text-decoration: none;
            display: inline-block;
        }

        .toggle-btn:hover {
            background-color: rgba(255, 255, 255, 0.5);
            transform: translateY(-2px);
        }

        .upload-btn:hover {
            background-color: rgba(255, 255, 255, 0.5);
            transform: translateY(-2px);
        }

        .upload-btn-wrapper {
            margin-bottom: 10px;
        }



        .upload-btn input[type=file] {
            font-size: 100px;
            position: absolute;
            left: 0;
            top: 0;
            opacity: 0;
            cursor: pointer;
        }

        /* === èƒŒæ™¯å›¾ç‰‡åº“å¼¹çª— === */
        .gallery-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.8);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .gallery-modal.show {
            display: flex;
            opacity: 1;
        }

        .gallery-content {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            padding: 2rem;
            width: 90%;
            max-width: 800px;
            max-height: 80vh;
            overflow-y: auto;
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
        }

        .gallery-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
            padding-bottom: 1rem;
            border-bottom: 2px solid rgba(255, 107, 107, 0.3);
        }

        .gallery-header h3 {
            color: var(--text-color);
            margin: 0;
            font-size: 1.5rem;
        }

        .close-btn {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: #666;
            transition: color 0.3s;
        }

        .close-btn:hover {
            color: var(--heart-color);
        }

        .gallery-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 15px;
        }

        .gallery-item {
            position: relative;
            border-radius: 10px;
            overflow: hidden;
            cursor: pointer;
            transition: transform 0.3s, box-shadow 0.3s;
            aspect-ratio: 16/9;
        }

        .gallery-item:hover {
            transform: scale(1.05);
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        }

        .gallery-item img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .gallery-item .delete-btn {
            position: absolute;
            top: 5px;
            right: 5px;
            background: rgba(255, 255, 255, 0.9);
            border: none;
            border-radius: 50%;
            width: 25px;
            height: 25px;
            cursor: pointer;
            display: none;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            transition: background-color 0.3s;
        }

        .gallery-item:hover .delete-btn {
            display: flex;
        }

        .gallery-item .delete-btn:hover {
            background: rgba(255, 107, 107, 0.9);
            color: white;
        }

        /* åŠ è½½çŠ¶æ€ */
        .loading {
            text-align: center;
            padding: 2rem;
            color: #666;
        }

        .empty-gallery {
            text-align: center;
            padding: 3rem;
            color: #666;
        }

        .empty-gallery p {
            font-size: 1.1rem;
            margin-bottom: 1rem;
        }

        /* === ç§»åŠ¨ç«¯é€‚é… === */
        @media (max-width: 768px) {
            .container {
                padding: 3rem 2rem;
                max-width: 98%;
            }
            header h1 { font-size: 2.8rem; }
            header p { font-size: 1rem; margin-bottom: 2rem; }
            
            .year-month-day-timer {
                grid-template-columns: repeat(3, 1fr);
                gap: 10px;
                margin-bottom: 1.5rem;
            }
            
            .year-month-day-value { font-size: 2rem; }
            .year-month-day-label { font-size: 0.7rem; }
            
            .timer-grid {
                grid-template-columns: repeat(3, 1fr);
                gap: 15px;
                margin-bottom: 2rem;
            }
            
            .time-value { font-size: 2.5rem; }
            .time-label { font-size: 0.9rem; }
            .footer-quote { font-size: 1rem; padding-top: 1.5rem;}

            .upload-btn {
                padding: 6px 10px;
                font-size: 0.7rem;
            }
            
            .upload-controls {
                left: 15px;
                bottom: 15px;
                gap: 8px;
            }
            
            .gallery-content {
                width: 95%;
                padding: 1.5rem;
                max-height: 90vh;
            }
            
            .gallery-grid {
                grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
                gap: 10px;
            }
        }
    </style>
</head>
<body class="default-bg">
    <!-- èƒŒæ™¯è½®æ’­å±‚ -->
    <div class="photo-carousel" id="photoCarousel">
        <div class="carousel-slide active" style="background-image: url('https://picsum.photos/seed/love1/1920/1080.jpg')"></div>
        <div class="carousel-slide" style="background-image: url('https://picsum.photos/seed/couple2/1920/1080.jpg')"></div>
        <div class="carousel-slide" style="background-image: url('https://picsum.photos/seed/romantic3/1920/1080.jpg')"></div>
        <div class="carousel-slide" style="background-image: url('https://picsum.photos/seed/sunset4/1920/1080.jpg')"></div>
        <div class="carousel-slide" style="background-image: url('https://picsum.photos/seed/hearts5/1920/1080.jpg')"></div>
    </div>

    <!-- è½®æ’­çŠ¶æ€æç¤º -->
    <div class="carousel-indicator" id="carouselIndicator">é»˜è®¤è½®æ’­ (1/5)</div>

    <!-- è£…é¥°çˆ±å¿ƒå±‚ -->
    <div class="bg-heart" style="top: 10%; left: 10%; font-size: 3rem; z-index: 25;">â¤</div>
    <div class="bg-heart" style="bottom: 20%; right: 15%; font-size: 5rem; animation-delay: 1s; z-index: 25;">â¤</div>
    <div class="bg-heart" style="top: 15%; right: 25%; font-size: 2.5rem; animation-delay: 2s; z-index: 25;">â¤</div>
    <div class="bg-heart" style="bottom: 10%; left: 10%; font-size: 3rem; animation-delay: 3s; z-index: 25;">â¤</div>

    <div class="container">
        <header>
            <h1>å®‹å®‡é£ <span class="heart-icon">â¤</span> å¼ å›½åº†</h1>
            <p>æˆ‘ä»¬ç›¸çˆ±äº†</p>
        </header>

        <!-- å¼€å§‹æ—¥æœŸæ˜¾ç¤º -->
        <div style="text-align: center; margin-bottom: 1.5rem;">
            <p style="font-size: 1.1rem; color: var(--light-text-color); opacity: 0.9; margin: 0; text-shadow: 0 2px 5px rgba(0,0,0,0.2);">
                ğŸ’• å¼€å§‹äº 2025å¹´9æœˆ8æ—¥ 13:14 ğŸ’•
            </p>
        </div>

        <!-- å¹´æœˆæ—¥è®¡æ—¶å™¨ -->
        <div class="year-month-day-timer" id="yearMonthDayTimer">
            <div class="year-month-day-box">
                <span class="year-month-day-value" id="years">0</span>
                <span class="year-month-day-label">å¹´</span>
            </div>
            <div class="year-month-day-box">
                <span class="year-month-day-value" id="months">0</span>
                <span class="year-month-day-label">æœˆ</span>
            </div>
            <div class="year-month-day-box">
                <span class="year-month-day-value" id="days">0</span>
                <span class="year-month-day-label">æ—¥</span>
            </div>
        </div>

        <!-- æ—¶åˆ†ç§’è®¡æ—¶å™¨ -->
        <div class="timer-grid" id="timer">
            <div class="time-box">
                <span class="time-value" id="hours">00</span>
                <span class="time-label">æ—¶</span>
            </div>
            <div class="time-box">
                <span class="time-value" id="minutes">00</span>
                <span class="time-label">åˆ†</span>
            </div>
            <div class="time-box">
                <span class="time-value" id="seconds">00</span>
                <span class="time-label">ç§’</span>
            </div>
        </div>

        <div class="footer-quote">
            "æ—¶é—´æ˜¯æœ€å¥½çš„è¯äººï¼Œè§è¯æˆ‘ä»¬çš„çˆ±æ—¥æ¸æ·±åšã€‚<br>
            æ¯ä¸€åˆ»ï¼Œéƒ½å› ä½ è€Œé—ªè€€ã€‚"
        </div>
    </div>

    <div class="upload-controls">
        <div class="upload-btn-wrapper">
            <button class="upload-btn">ğŸ“¤ ä¸Šä¼ èƒŒæ™¯å›¾</button>
            <input type="file" id="bgFileInput" accept="image/*">
        </div>
        <button class="upload-btn" onclick="toggleGallery()">ğŸ–¼ï¸ èƒŒæ™¯å›¾åº“</button>
        <button class="upload-btn" onclick="toggleCarousel()">ğŸ”„ åˆ‡æ¢è½®æ’­</button>
        <button class="upload-btn" onclick="resetToDefault()">ğŸ”„ æ¢å¤é»˜è®¤</button>
    </div>

    <!-- èƒŒæ™¯å›¾ç‰‡åº“å¼¹çª— -->
    <div class="gallery-modal" id="galleryModal">
        <div class="gallery-content">
            <div class="gallery-header">
                <h3>ğŸ–¼ï¸ èƒŒæ™¯å›¾ç‰‡åº“</h3>
                <button class="close-btn" onclick="toggleGallery()">âœ–</button>
            </div>
            <div class="gallery-grid" id="galleryGrid">
                <!-- èƒŒæ™¯å›¾ç‰‡å°†åŠ¨æ€åŠ è½½åˆ°è¿™é‡Œ -->
            </div>
        </div>
    </div>

    <script>
        // ================= é…ç½®åŒºåŸŸ =================
        // 1. è®¾ç½®ä½ ä»¬åœ¨ä¸€èµ·çš„å¼€å§‹æ—¶é—´ (æ ¼å¼: YYYY-MM-DDTHH:MM:SS)
        const startDate = new Date('2025-09-08T13:14:00');
        
        // æœåŠ¡å™¨é…ç½®
        const SERVER_URL = window.location.origin.includes('localhost') ? 
            'http://localhost:3000' : 
            window.location.origin;
        
        // ================= è½®æ’­é€»è¾‘åŒºåŸŸ =================
        let carouselMode = 'default'; // 'default' æˆ– 'user'
        let currentDefaultSlide = 0;
        let currentUsersSlide = 0;
        
        // é»˜è®¤èƒŒæ™¯å›¾ç‰‡
        const defaultBackgrounds = [
            'https://picsum.photos/seed/love1/1920/1080.jpg',
            'https://picsum.photos/seed/couple2/1920/1080.jpg', 
            'https://picsum.photos/seed/romantic3/1920/1080.jpg',
            'https://picsum.photos/seed/sunset4/1920/1080.jpg',
            'https://picsum.photos/seed/hearts5/1920/1080.jpg'
        ];
        
        // ç”¨æˆ·ä¸Šä¼ çš„å›¾ç‰‡ï¼ˆä»localStorageè·å–ï¼‰
        let userBackgrounds = [];
        
        // åˆå§‹åŒ–è½®æ’­
        function initCarousel() {
            // åŠ è½½ç”¨æˆ·å›¾ç‰‡
            const stored = localStorage.getItem('userBackgrounds');
            if (stored) {
                userBackgrounds = JSON.parse(stored);
            }
            
            updateCarousel();
            
            // æ¯5ç§’åˆ‡æ¢ä¸€æ¬¡
            setInterval(() => {
                if (carouselMode === 'default') {
                    currentDefaultSlide = (currentDefaultSlide + 1) % defaultBackgrounds.length;
                } else {
                    if (userBackgrounds.length > 0) {
                        currentUsersSlide = (currentUsersSlide + 1) % userBackgrounds.length;
                    }
                }
                updateCarousel();
            }, 5000);
        }
        
        // æ›´æ–°è½®æ’­æ˜¾ç¤º
        function updateCarousel() {
            const slides = document.querySelectorAll('.carousel-slide');
            const indicator = document.getElementById('carouselIndicator');
            
            let imageUrl, slideIndex, totalSlides;
            
            if (carouselMode === 'default' || userBackgrounds.length === 0) {
                imageUrl = defaultBackgrounds[currentDefaultSlide];
                slideIndex = currentDefaultSlide + 1;
                totalSlides = defaultBackgrounds.length;
                carouselMode = 'default';
            } else {
                imageUrl = userBackgrounds[currentUsersSlide];
                slideIndex = currentUsersSlide + 1;
                totalSlides = userBackgrounds.length;
            }
            
            // æ›´æ–°è½®æ’­å›¾ç‰‡
            slides.forEach(slide => {
                slide.style.backgroundImage = `url(${imageUrl})`;
            });
            
            // æ›´æ–°æŒ‡ç¤ºå™¨
            indicator.textContent = `${carouselMode === 'default' ? 'é»˜è®¤è½®æ’­' : 'ç”¨æˆ·è½®æ’­'} (${slideIndex}/${totalSlides})`;
        }
        
        // åˆ‡æ¢è½®æ’­æ¨¡å¼
        function toggleCarousel() {
            if (userBackgrounds.length === 0) {
                showNotification('âŒ æ²¡æœ‰ç”¨æˆ·ä¸Šä¼ çš„å›¾ç‰‡', 'error');
                return;
            }
            
            carouselMode = carouselMode === 'default' ? 'user' : 'default';
            currentDefaultSlide = 0;
            currentUsersSlide = 0;
            updateCarousel();
            
            const modeText = carouselMode === 'default' ? 'é»˜è®¤è½®æ’­' : 'ç”¨æˆ·è½®æ’­';
            showNotification(`âœ… å·²åˆ‡æ¢åˆ°${modeText}`);
        }
        
        // ================= é€»è¾‘åŒºåŸŸ =================

        // è®¡æ—¶å™¨æ›´æ–°å‡½æ•°
        function updateTimer() {
            const now = new Date();
            const diff = now - startDate;

            if (diff >= 0) {
                // è®¡ç®—å¹´æœˆæ—¥æ—¶åˆ†ç§’
                const years = Math.floor(diff / (1000 * 60 * 60 * 24 * 365));
                const months = Math.floor((diff % (1000 * 60 * 60 * 24 * 365)) / (1000 * 60 * 60 * 24 * 30));
                const days = Math.floor((diff % (1000 * 60 * 60 * 24 * 30)) / (1000 * 60 * 60 * 24));
                const hours = Math.floor((diff / (1000 * 60 * 60)) % 24);
                const minutes = Math.floor((diff / (1000 * 60)) % 60);
                const seconds = Math.floor((diff / 1000) % 60);

                // æ›´æ–°å¹´æœˆæ—¥
                document.getElementById('years').innerText = years;
                document.getElementById('months').innerText = months;
                document.getElementById('days').innerText = days;
                
                // æ›´æ–°æ—¶åˆ†ç§’
                document.getElementById('hours').innerText = hours.toString().padStart(2, '0');
                document.getElementById('minutes').innerText = minutes.toString().padStart(2, '0');
                document.getElementById('seconds').innerText = seconds.toString().padStart(2, '0');
            }
        }
        updateTimer();
        setInterval(updateTimer, 1000);

        // èƒŒæ™¯å›¾å¤„ç†å‡½æ•°
        const bgFileInput = document.getElementById('bgFileInput');
        const body = document.body;
        const storedBg = localStorage.getItem('customBackground');

        // åŠ è½½ä¹‹å‰ä¿å­˜çš„èƒŒæ™¯å›¾
        if (storedBg) {
            body.style.backgroundImage = `url(${storedBg})`;
            body.classList.remove('default-bg');
        } else {
            body.classList.add('default-bg');
        }
        
        // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–è½®æ’­
        window.addEventListener('load', () => {
            initCarousel();
        });

        // ä¸Šä¼ å›¾ç‰‡åˆ°æœåŠ¡å™¨
        bgFileInput.addEventListener('change', async function(event) {
            const file = event.target.files[0];
            if (file) {
                try {
                    // æ˜¾ç¤ºä¸Šä¼ ä¸­çŠ¶æ€
                    const uploadBtn = document.querySelector('.upload-btn');
                    const originalText = uploadBtn.textContent;
                    uploadBtn.textContent = 'ğŸ“¤ ä¸Šä¼ ä¸­...';
                    uploadBtn.disabled = true;

                    const formData = new FormData();
                    formData.append('image', file);

                    const response = await fetch(`${SERVER_URL}/api/upload`, {
                        method: 'POST',
                        body: formData
                    });

                    const result = await response.json();
                    
                    if (result.success) {
                        const imageUrl = `${SERVER_URL}${result.background.url}`;
                        body.style.backgroundImage = `url(${imageUrl})`;
                        body.classList.remove('default-bg');
                        localStorage.setItem('customBackground', imageUrl);
                        
                        // æ·»åŠ åˆ°ç”¨æˆ·è½®æ’­
                        if (!userBackgrounds.includes(imageUrl)) {
                            userBackgrounds.push(imageUrl);
                            localStorage.setItem('userBackgrounds', JSON.stringify(userBackgrounds));
                            updateCarousel();
                        }
                        
                        // åˆ·æ–°å›¾ç‰‡åº“
                        loadGallery();
                        
                        // æ˜¾ç¤ºæˆåŠŸæç¤º
                        showNotification('âœ… èƒŒæ™¯å›¾ä¸Šä¼ æˆåŠŸï¼å·²åŠ å…¥è½®æ’­');
                    } else {
                        showNotification('âŒ ä¸Šä¼ å¤±è´¥ï¼Œè¯·é‡è¯•', 'error');
                    }
                } catch (error) {
                    console.error('ä¸Šä¼ é”™è¯¯:', error);
                    showNotification('âŒ ä¸Šä¼ å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥', 'error');
                } finally {
                    const uploadBtn = document.querySelector('.upload-btn');
                    uploadBtn.textContent = originalText;
                    uploadBtn.disabled = false;
                    bgFileInput.value = ''; // æ¸…ç©ºæ–‡ä»¶è¾“å…¥
                }
            }
        });

        // åˆ‡æ¢å›¾ç‰‡åº“æ˜¾ç¤º
        function toggleGallery() {
            const modal = document.getElementById('galleryModal');
            if (modal.classList.contains('show')) {
                modal.classList.remove('show');
            } else {
                modal.classList.add('show');
                loadGallery();
            }
        }

        // åŠ è½½å›¾ç‰‡åº“
        async function loadGallery() {
            const galleryGrid = document.getElementById('galleryGrid');
            galleryGrid.innerHTML = '<div class="loading">ğŸ“¸ åŠ è½½ä¸­...</div>';

            try {
                const response = await fetch(`${SERVER_URL}/api/backgrounds`);
                const backgrounds = await response.json();

                if (backgrounds.length === 0) {
                    galleryGrid.innerHTML = `
                        <div class="empty-gallery">
                            <p>ğŸ¨ è¿˜æ²¡æœ‰èƒŒæ™¯å›¾</p>
                            <p>å¿«æ¥ä¸Šä¼ ç¬¬ä¸€å¼ èƒŒæ™¯å›¾å§ï¼</p>
                        </div>
                    `;
                    return;
                }

                galleryGrid.innerHTML = backgrounds.map(bg => `
                    <div class="gallery-item" onclick="selectBackground('${SERVER_URL}${bg.url}')">
                        <img src="${SERVER_URL}${bg.url}" alt="${bg.originalName}" loading="lazy">
                        <button class="delete-btn" onclick="event.stopPropagation(); deleteBackground('${bg.id}')">ğŸ—‘ï¸</button>
                    </div>
                `).join('');
            } catch (error) {
                console.error('åŠ è½½å›¾ç‰‡åº“é”™è¯¯:', error);
                galleryGrid.innerHTML = `
                    <div class="empty-gallery">
                        <p>âŒ åŠ è½½å¤±è´¥</p>
                        <p>è¯·æ£€æŸ¥ç½‘ç»œè¿æ¥</p>
                    </div>
                `;
            }
        }

        // é€‰æ‹©èƒŒæ™¯å›¾
        function selectBackground(imageUrl) {
            body.style.backgroundImage = `url(${imageUrl})`;
            body.classList.remove('default-bg');
            localStorage.setItem('customBackground', imageUrl);
            toggleGallery();
            showNotification('âœ… èƒŒæ™¯å›¾å·²æ›´æ¢ï¼');
        }

        // åˆ é™¤èƒŒæ™¯å›¾
        async function deleteBackground(id) {
            if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™å¼ èƒŒæ™¯å›¾å—ï¼Ÿ')) {
                return;
            }

            try {
                const response = await fetch(`${SERVER_URL}/api/backgrounds/${id}`, {
                    method: 'DELETE'
                });

                if (response.ok) {
                    loadGallery();
                    showNotification('âœ… èƒŒæ™¯å›¾å·²åˆ é™¤');
                } else {
                    showNotification('âŒ åˆ é™¤å¤±è´¥', 'error');
                }
            } catch (error) {
                console.error('åˆ é™¤é”™è¯¯:', error);
                showNotification('âŒ åˆ é™¤å¤±è´¥ï¼Œè¯·é‡è¯•', 'error');
            }
        }

        // æ¢å¤é»˜è®¤èƒŒæ™¯
        function resetToDefault() {
            body.style.backgroundImage = '';
            body.classList.add('default-bg');
            localStorage.removeItem('customBackground');
            showNotification('âœ… å·²æ¢å¤é»˜è®¤èƒŒæ™¯');
        }

        // æ˜¾ç¤ºé€šçŸ¥
        function showNotification(message, type = 'success') {
            // åˆ›å»ºé€šçŸ¥å…ƒç´ 
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: ${type === 'success' ? 'rgba(76, 175, 80, 0.9)' : 'rgba(244, 67, 54, 0.9)'};
                color: white;
                padding: 15px 20px;
                border-radius: 10px;
                backdrop-filter: blur(10px);
                -webkit-backdrop-filter: blur(10px);
                z-index: 2000;
                animation: slideIn 0.3s ease;
                max-width: 300px;
                font-size: 0.9rem;
            `;
            notification.textContent = message;

            // æ·»åŠ åŠ¨ç”»æ ·å¼
            const style = document.createElement('style');
            style.textContent = `
                @keyframes slideIn {
                    from {
                        transform: translateX(100%);
                        opacity: 0;
                    }
                    to {
                        transform: translateX(0);
                        opacity: 1;
                    }
                }
                @keyframes slideOut {
                    from {
                        transform: translateX(0);
                        opacity: 1;
                    }
                    to {
                        transform: translateX(100%);
                        opacity: 0;
                    }
                }
            `;
            document.head.appendChild(style);

            document.body.appendChild(notification);

            // 3ç§’åè‡ªåŠ¨æ¶ˆå¤±
            setTimeout(() => {
                notification.style.animation = 'slideOut 0.3s ease';
                setTimeout(() => {
                    if (notification.parentNode) {
                        notification.parentNode.removeChild(notification);
                    }
                    if (style.parentNode) {
                        style.parentNode.removeChild(style);
                    }
                }, 300);
            }, 3000);
        }

        // ç‚¹å‡»å¼¹çª—èƒŒæ™¯å…³é—­
        document.getElementById('galleryModal').addEventListener('click', function(e) {
            if (e.target === this) {
                toggleGallery();
            }
        });

        // é¡µé¢åŠ è½½æ—¶å°è¯•è‡ªåŠ¨åŠ è½½æœåŠ¡å™¨çŠ¶æ€
        window.addEventListener('load', function() {
            // æ£€æŸ¥æœåŠ¡å™¨æ˜¯å¦åœ¨çº¿
            fetch(`${SERVER_URL}/api/backgrounds`).catch(() => {
                console.log('æœåŠ¡å™¨æœªå¯åŠ¨ï¼Œä½¿ç”¨æœ¬åœ°æ¨¡å¼');
            });
        });
    </script>
</body>
</html>